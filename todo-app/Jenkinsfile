pipeline {
    agent any

    // Assurez-vous que ces outils sont configur√©s dans "Global Tool Configuration" de Jenkins
    tools {
        maven 'Maven 3' // Nom de votre installation Maven dans Jenkins
        jdk 'Java 17'   // Nom de votre installation JDK 17 dans Jenkins
    }

    environment {
        // Optionnel : Variables d'environnement pour SonarQube si n√©cessaire
        // SONAR_HOST_URL = 'http://localhost:9000'
    }

    stages {
        stage('Initialize') {
            steps {
                echo 'üöÄ D√©marrage du Pipeline ISTQB Todo-App...'
                sh 'mvn --version'
                sh 'java -version'
            }
        }

        stage('Build & Compile') {
            steps {
                echo 'üî® Compilation du code source...'
                // Compile sans lancer les tests pour v√©rifier la syntaxe rapidement
                sh 'mvn clean compile'
            }
        }

        stage('Test & Quality Gate') {
            steps {
                echo 'üß™ Ex√©cution des Tests (Unitaires, Int√©gration, Performance)...'
                echo 'üìä V√©rification de la couverture JaCoCo (> 80%)...'

                // C'est ICI que la magie op√®re :
                // 'verify' lance les tests ET v√©rifie la r√®gle JaCoCo que nous avons configur√©e dans le pom.xml
                // Si la couverture est < 80%, le build Jenkins deviendra ROUGE (√âchec).
                sh 'mvn verify'
            }
        }

        // √âtape Optionnelle : Si vous avez le plugin SonarQube install√© sur Jenkins
        /*
        stage('Static Analysis (SonarQube)') {
            steps {
                withSonarQubeEnv('SonarQube') {
                    sh 'mvn sonar:sonar'
                }
            }
        }
        */
    }

    post {
        always {
            echo 'üìù Archivage des rapports de test...'
            // R√©cup√®re les r√©sultats JUnit pour les afficher graphiquement dans Jenkins
            junit 'target/surefire-reports/*.xml'

            // Archive le rapport JaCoCo pour qu'il soit t√©l√©chargeable
            publishHTML (target: [
                allowMissing: false,
                alwaysLinkToLastBuild: true,
                keepAll: true,
                reportDir: 'target/site/jacoco',
                reportFiles: 'index.html',
                reportName: 'Rapport Couverture Code'
            ])
        }
        success {
            echo '‚úÖ SUCC√àS : Le projet respecte tous les crit√®res ISTQB !'
        }
        failure {
            echo '‚ùå √âCHEC : Qualit√© insuffisante ou Tests √©chou√©s.'
        }
    }
}