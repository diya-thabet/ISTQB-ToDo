pipeline {
    agent any

    stages {
        stage('Initialize') {
            steps {
                echo 'üöÄ D√©marrage du Pipeline ISTQB Todo-App...'
                // Rend le wrapper ex√©cutable (au cas o√π les permissions Git seraient perdues)
                sh 'chmod +x mvnw'
                // V√©rifie que Java et Maven Wrapper fonctionnent
                sh './mvnw -version'
            }
        }

        stage('Build & Compile') {
            steps {
                echo 'üî® Compilation du code source...'
                // Compile le code sans lancer les tests (rapide)
                sh './mvnw clean compile'
            }
        }

        stage('Test & Quality Gate') {
            steps {
                echo 'üß™ Ex√©cution des Tests (Unitaires, Int√©gration, Performance)...'
                echo 'üìä V√©rification de la couverture JaCoCo (> 80%)...'
                
                // Lance les tests et v√©rifie la couverture
                // Si JaCoCo < 80%, cette commande retournera une erreur et le build deviendra ROUGE
                sh './mvnw verify'
            }
        }
    }

    post {
        always {
            echo 'üìù Archivage des rapports de test...'
            // R√©cup√®re les r√©sultats JUnit pour les graphiques Jenkins
            junit 'target/surefire-reports/*.xml'
            
            // Archive le rapport JaCoCo
            // Note: Assurez-vous que le plugin "HTML Publisher" est install√© dans Jenkins
            publishHTML (target: [
                allowMissing: false,
                alwaysLinkToLastBuild: true,
                keepAll: true,
                reportDir: 'target/site/jacoco',
                reportFiles: 'index.html',
                reportName: 'Rapport Couverture Code'
            ])
        }
        success {
            echo '‚úÖ SUCC√àS : Le projet respecte tous les crit√®res ISTQB !'
        }
        failure {
            echo '‚ùå √âCHEC : Qualit√© insuffisante ou Tests √©chou√©s.'
        }
    }
}